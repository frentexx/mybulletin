import React, { useState, useEffect, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  GoogleAuthProvider, 
  signInWithPopup, 
  onAuthStateChanged, 
  signOut,
  signInAnonymously,
  signInWithCustomToken
} from 'firebase/auth';

// 假設這些全域變數已由環境提供 (依據平台規範)
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// 必要的網域限制
const REQUIRED_DOMAIN = '@ppsh.ptc.edu.tw';
const APP_NAME = '校園公告系統';

// 初始化 Firebase 應用程式
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

// 啟用 Firebase 偵錯日誌
// import { setLogLevel } from 'firebase/firestore';
// setLogLevel('debug'); 

const LoadingSpinner = () => (
    <div className="flex flex-col items-center justify-center p-8">
        <div className="animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-orange-500 border-opacity-75"></div>
        <p className="mt-4 text-gray-600">驗證中，請稍候...</p>
    </div>
);

const UserInfo = ({ user }) => (
    <div className="text-sm text-gray-600 mb-4 p-3 bg-gray-50 border-l-4 border-orange-500 rounded-r-lg shadow-sm">
        <p>
            已登入為: <span className="font-semibold text-gray-800">{user.email}</span>
        </p>
        <p>
            帳號 ID: <span className="font-mono text-xs">{user.uid}</span>
        </p>
    </div>
);

// 主應用程式元件
const App = () => {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [isAuthorized, setIsAuthorized] = useState(false);
  const [error, setError] = useState(null);

  // 1. 處理 Firebase 驗證初始化
  useEffect(() => {
    const initializeAuth = async () => {
      try {
        if (initialAuthToken) {
          await signInWithCustomToken(auth, initialAuthToken);
        } else {
          await signInAnonymously(auth);
        }
      } catch (e) {
        console.error("Custom token or anonymous sign-in failed:", e);
      }
    };
    initializeAuth();
    
    // 監聽驗證狀態變化
    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
        setUser(currentUser);
        setLoading(false);
        setError(null);
        
        if (currentUser && currentUser.email) {
            // 2. 核心邏輯：網域檢查
            const isDomainMatch = currentUser.email.toLowerCase().endsWith(REQUIRED_DOMAIN.toLowerCase());
            setIsAuthorized(isDomainMatch);

            if (!isDomainMatch) {
                // 如果網域不符合，設定錯誤訊息
                setError(`您的帳號 (${currentUser.email}) 不屬於授權網域 (${REQUIRED_DOMAIN})，無法瀏覽公告。`);
                // 為了安全，可以考慮在這裡登出，但我們先保留登入狀態讓用戶自行登出
            }
        } else {
            // 如果沒有登入或匿名登入，清除授權狀態
            setIsAuthorized(false);
        }
    });

    return () => unsubscribe();
  }, []); // 僅在元件掛載時執行一次

  // 處理 Google 登入
  const handleGoogleSignIn = useCallback(async () => {
    setLoading(true);
    setError(null);
    try {
        const provider = new GoogleAuthProvider();
        // 確保 Google 每次都要求選擇帳號，如果需要的話
        // provider.setCustomParameters({ prompt: 'select_account' }); 
        await signInWithPopup(auth, provider);
        // onAuthStateChanged 會自動處理後續的授權檢查
    } catch (e) {
        if (e.code === 'auth/popup-closed-by-user') {
            setError('登入視窗已關閉。');
        } else if (e.code === 'auth/cancelled-popup-request') {
             setError('登入程序取消，請勿重複點擊按鈕。');
        } else {
            setError(`登入失敗: ${e.message}`);
        }
        console.error("Google Sign-In Error:", e);
    } finally {
        setLoading(false);
    }
  }, []);

  // 處理登出
  const handleSignOut = useCallback(async () => {
    try {
        await signOut(auth);
        setUser(null);
        setIsAuthorized(false);
        setError(null);
    } catch (e) {
        setError('登出失敗，請重試。');
    }
  }, []);

  // 渲染登入/登出按鈕
  const renderAuthButton = () => {
    if (user && user.email) {
      return (
        <button
          onClick={handleSignOut}
          className="w-full md:w-auto px-6 py-3 bg-red-600 text-white font-bold rounded-lg shadow-md hover:bg-red-700 transition duration-150"
        >
          登出 ({user.email.split('@')[0]})
        </button>
      );
    }

    // 只有在非匿名登入狀態下才顯示 Google 登入按鈕
    if (!loading && !user) {
        return (
            <button
                onClick={handleGoogleSignIn}
                className="w-full md:w-auto px-6 py-3 bg-[#EF6C00] text-white font-bold rounded-lg shadow-md hover:bg-orange-700 transition duration-150 flex items-center justify-center"
            >
                <svg className="w-5 h-5 mr-2" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M44.5 20H24V28H35.8C35.2 31.5 33.3 34.3 30.2 36.3L30.2 36.4L37.8 42.4L38.2 42.8C42.8 38.3 45.5 31.8 45.5 24C45.5 22.8 45.4 21.5 45.1 20.3L44.5 20Z" fill="#FFC107"/>
                    <path d="M12.5 24C12.5 26 13 27.9 14 29.5L14 29.6L6.5 35.6L6.1 36C4 32.2 2.9 28.2 2.9 24C2.9 19.8 4 15.8 6.1 12L6.5 12.4L14 18.4C13 20.1 12.5 22 12.5 24Z" fill="#4CAF50"/>
                    <path d="M24 10.5C27.5 10.5 30.6 11.9 33 14.1L38.2 8.9C34.5 5.5 29.5 3.5 24 3.5C18.5 3.5 13.5 5.5 9.8 8.9L15 14.1C17.4 11.9 20.5 10.5 24 10.5Z" fill="#FBC02D"/>
                    <path d="M44.5 20H24V28H35.8C35.2 31.5 33.3 34.3 30.2 36.3L30.2 36.4L37.8 42.4L38.2 42.8C42.8 38.3 45.5 31.8 45.5 24C45.5 22.8 45.4 21.5 45.1 20.3L44.5 20Z" fill="#1565C0"/>
                </svg>
                使用 Google 帳號登入
            </button>
        );
    }
    return null; // 載入中不顯示按鈕
  };


  return (
    <div className="min-h-screen bg-[#FAFAF5] p-4 md:p-8 font-sans">
      <div className="max-w-4xl mx-auto bg-white shadow-xl rounded-xl p-6 md:p-10">
        
        {/* 標題區 */}
        <header className="mb-8 border-b pb-4">
          <h1 className="text-3xl font-extrabold text-[#333333] mb-2">
            {APP_NAME}
          </h1>
          <p className="text-gray-500">
            本系統僅限 <span className="font-mono font-bold text-[#EF6C00]">{REQUIRED_DOMAIN}</span> 網域使用者登入。
          </p>
        </header>

        {/* 驗證及內容區 */}
        {loading ? (
            <LoadingSpinner />
        ) : (
            <main>
                {user && user.email && <UserInfo user={user} />}

                {/* 顯示錯誤訊息 */}
                {error && (
                    <div className="p-4 mb-6 bg-red-100 border-l-4 border-red-500 text-red-700 rounded-lg shadow-sm">
                        <p className="font-bold">❌ 存取被拒！網域驗證失敗</p>
                        <p className="mt-1 text-sm">{error}</p>
                    </div>
                )}
                
                {/* 授權後的公告內容 */}
                {isAuthorized ? (
                    <div className="p-6 bg-[#4CAF50]/10 border border-[#4CAF50] text-[#4CAF50] rounded-lg shadow-inner">
                        <h2 className="text-2xl font-bold mb-4 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 mr-2 fill-current" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                            {REQUIRED_DOMAIN} 專屬校園公告
                        </h2>
                        <p className="mb-4">
                            您已成功通過網域驗證，可以瀏覽以下機密公告。
                        </p>
                        
                        {/* 模擬公告列表 */}
                        <ul className="space-y-3">
                            <li className="p-3 bg-white rounded-md shadow text-gray-800 transition hover:shadow-lg">
                                <span className="font-semibold text-orange-600 mr-2">[重要]</span> 113學年度校務會議決議事項公告
                            </li>
                            <li className="p-3 bg-white rounded-md shadow text-gray-800 transition hover:shadow-lg">
                                <span className="font-semibold text-blue-600 mr-2">[通知]</span> 學生社團指導老師會議紀錄 (僅供內部查閱)
                            </li>
                            <li className="p-3 bg-white rounded-md shadow text-gray-800 transition hover:shadow-lg">
                                <span className="font-semibold text-green-600 mr-2">[行政]</span> 資訊系統維護與停機時間表
                            </li>
                        </ul>
                    </div>

                ) : (
                    // 尚未登入或未授權的提示
                    <div className="p-6 bg-blue-100 border-l-4 border-blue-500 text-blue-700 rounded-lg shadow-sm">
                        <p className="font-bold mb-2">🔐 請先登入以瀏覽內容</p>
                        <p className="text-sm">請點擊下方按鈕，使用您的 {REQUIRED_DOMAIN} 網域帳號登入系統。</p>
                    </div>
                )}
                
                {/* 底部按鈕區 */}
                <div className="mt-8 pt-6 border-t flex justify-end">
                    {renderAuthButton()}
                </div>
            </main>
        )}
      </div>
    </div>
  );
};

export default App;
